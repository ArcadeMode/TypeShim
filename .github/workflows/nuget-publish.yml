name: Publish NuGet

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Tag to publish v[0-9]+.[0-9]+.[0-9]+*'
        required: true
        default: ''
        type: string
  push:
    tags: 
      - "v[0-9]+.[0-9]+.[0-9]+*"

jobs:
  publish:
    runs-on: windows-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Determine and validate version
        id: ver
        shell: pwsh
        env:
          INPUT_VERSION: ${{ inputs.version }}
          REF_TYPE: ${{ github.ref_type }}
          REF_NAME: ${{ github.ref_name }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          $inputVersion = "$env:INPUT_VERSION".Trim()
          $tagVersion   = if ($env:REF_TYPE -eq 'tag') { "$env:REF_NAME".Trim() } else { '' }
          $raw = if ($inputVersion) { $inputVersion } elseif ($tagVersion) { $tagVersion } else { '' }

          if (-not $raw) { Write-Error "No version provided via workflow_dispatch or tag push."; exit 1 }

          # normalize: allow leading 'v'
          $ver = $raw -replace '^v', ''

          # SemVer 2.0.0: x.y.z with optional -prerelease and +build
          $semverPattern = '^(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)(?:-[0-9A-Za-z-]+(?:\.[0-9A-Za-z-]+)*)?(?:\+[0-9A-Za-z-]+(?:\.[0-9A-Za-z-]+)*)?$'
          if ($ver -notmatch $semverPattern) {
            Write-Error "Invalid SemVer: '$ver'. Expected x.y.z[ -prerelease ][ +build ]."; exit 1
          }

          Write-Host "Version: $ver"
          "version=$ver" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Restore
        run: dotnet restore TypeShim.slnx

      - name: Build
        run: dotnet build TypeShim.slnx -c Release --no-restore

      - name: Test
        run: dotnet test TypeShim.slnx -c Release --no-build

      - name: Pack TypeShim
        env:
          PKG_VERSION: ${{ steps.ver.outputs.version }}
        run: >
          dotnet pack TypeShim/TypeShim.csproj 
          -c Release 
          -o .\.artifacts\nuget 
          --no-build 
          -p:Version=$env:PKG_VERSION 
          -p:ContinuousIntegrationBuild=true

      - name: Configure GitHub Packages source
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: >
          dotnet nuget add source 
          --username ArcadeMode 
          --password "$env:GITHUB_TOKEN" 
          --store-password-in-clear-text 
          --name github "https://nuget.pkg.github.com/ArcadeMode/index.json"

      - name: Push to GitHub Packages
        run: |
          $pkg = Get-ChildItem -Path .\.artifacts\nuget -Filter *.nupkg | Select-Object -First 1
          dotnet nuget push $pkg.FullName `
            --source github `
            --skip-duplicate
